# MetronomeMegaMax 要件定義書

## 1. プロジェクト概要

### 1.1 アプリ名
**MetronomeMegaMax**

### 1.2 コンセプト
メトロノーム、タイマー、音源再生機能を1つに統合した楽器練習アプリ。
ギタリストを主なターゲットとしつつ、あらゆる楽器の練習に対応する汎用性を持つ。

### 1.3 最重要要件
> **メトロノームのテンポは常に正確に鳴らす**
>
> この要件は他のすべての機能より優先される。アプリが重くなりテンポが狂う可能性がある機能は実装しない。

### 1.4 対応プラットフォーム
| プラットフォーム | 対応 |
|------------------|------|
| iOS | ○ |
| Android | × |
| Web | ○ |

### 1.5 対応言語
- 日本語
- 英語
- スペイン語

---

## 2. 技術スタック

### 2.1 フロントエンド
| 項目 | 技術 |
|------|------|
| フレームワーク | React Native |
| Web対応 | React Native for Web |
| 言語 | TypeScript |

### 2.2 バックエンド
| 項目 | 技術 |
|------|------|
| BaaS | Firebase |
| 認証 | Firebase Authentication (Google Sign-In) |
| データベース | Firebase Firestore |
| ファイルストレージ | Firebase Storage（音源ファイル保存用） |
| 課金管理 | Firebase + RevenueCat または カスタム実装 |

### 2.3 決済
| プラットフォーム | 決済サービス |
|------------------|--------------|
| iOS | App Store In-App Purchase |
| Web | Stripe |

### 2.4 オーディオ処理
| プラットフォーム | 実装方式 |
|------------------|----------|
| iOS | ネイティブモジュール（Swift / AVAudioEngine） |
| Web | Web Audio API |

**理由:** JavaScript（setInterval等）ではタイミング精度が保証できないため、プラットフォームネイティブのオーディオエンジンを使用する。

---

## 3. 機能仕様

### 3.1 メトロノーム機能

#### 3.1.1 BPM設定
| 項目 | 仕様 |
|------|------|
| 範囲 | 20〜300 BPM |
| 設定方法 | ±ボタン（1ずつ増減） / 数値直接入力 |

#### 3.1.2 拍子
以下の10種類に対応：

| 単純拍子 | 複合拍子 |
|----------|----------|
| 2/4 | 3/8 |
| 3/4 | 6/8 |
| 4/4 | 9/8 |
| 5/4 | 12/8 |
| 6/4 | |
| 7/4 | |

#### 3.1.3 アクセント
以下の3パターンから選択：

| パターン | 説明 | 用途例 |
|----------|------|--------|
| 1拍目 | 1拍目のみアクセント | 基本パターン |
| 1・3拍目 | 1拍目と3拍目にアクセント | マーチ等 |
| 2・4拍目 | 2拍目と4拍目にアクセント | バックビート（ロック・ポップス） |

#### 3.1.4 音色
- 1種類のみ（選択機能なし）

#### 3.1.5 プリセット保存（有料版のみ）
| 項目 | 仕様 |
|------|------|
| 保存数上限 | 10個 |
| 保存内容 | BPM + 拍子 + アクセントパターン |
| 同期 | Firestore経由でデバイス間同期 |

---

### 3.2 タイマー機能

#### 3.2.1 基本仕様
| 項目 | 仕様 |
|------|------|
| 種類 | カウントダウンのみ |
| 最小単位 | 1秒 |
| 最大時間 | 24時間 |
| 用途 | 練習時間の目標設定（例：30分練習する） |

#### 3.2.2 時間設定方法
**方法1: 加算ボタン**
| ボタン | 加算時間 |
|--------|----------|
| 30秒 | +30秒 |
| 1分 | +1分 |
| 3分 | +3分 |
| 5分 | +5分 |
| 10分 | +10分 |
| 30分 | +30分 |

**方法2: 数値直接入力**
- 時:分:秒 形式で入力

#### 3.2.3 操作
| 操作 | 説明 |
|------|------|
| スタート | カウントダウン開始 |
| 一時停止 | カウントダウン中断（時間保持） |
| 再開 | 一時停止から再開 |
| リセット | 設定時間をクリア（00:00:00に戻す） |

#### 3.2.4 終了時動作
- アラーム音を鳴らす
- プッシュ通知は不要

#### 3.2.5 プリセット保存（有料版のみ）
| 項目 | 仕様 |
|------|------|
| 保存数上限 | 10個 |
| 保存内容 | 設定時間（HH:MM:SS） |
| 同期 | Firestore経由でデバイス間同期 |

---

### 3.3 音源再生機能

#### 3.3.1 基本仕様
| 項目 | 仕様 |
|------|------|
| 音源取得元 | 端末内ローカルファイル |
| 対応フォーマット | mp3, wav |
| メトロノーム同時再生 | 対応 |

#### 3.3.2 無料版機能
- 通常再生（再生 / 一時停止 / 停止）
- シークバーでの位置変更

#### 3.3.3 有料版追加機能

**A-Bリピート（ループ再生）**
| 項目 | 仕様 |
|------|------|
| 機能 | 開始点(A)と終了点(B)を設定し、その区間をループ再生 |
| 設定方法 | 再生中に「A設定」「B設定」ボタンをタップ |

**ループポイント保存（音源クラウド同期）**
| 項目 | 仕様 |
|------|------|
| 保存数上限 | 3個 |
| 保存内容 | 音源ファイル + A点位置 + B点位置 |
| ファイルサイズ上限 | 1ファイル20MBまで |
| ストレージ | Firebase Storage |
| メタデータ | Firestore（ファイル参照URL、A点、B点、ファイル名） |
| 呼び出し方法 | 選択ボックス（ドロップダウン）から選択 |
| 同期 | デバイス間同期対応（別端末でも同じ音源を呼び出し可能） |
| 用途 | 練習したいフレーズを保存しておき、どの端末からでも呼び出せる |

**注意事項（利用規約に明記）:**
- ユーザーは著作権を侵害しないファイルのみアップロード可能
- 違反が確認された場合はアカウント停止の可能性あり

**再生速度変更**
| 速度 | 用途例 |
|------|--------|
| 0.5倍 | ゆっくり確認 |
| 0.75倍 | やや遅め |
| 1倍 | 通常速度 |
| 1.25倍 | やや速め |
| 1.5倍 | 速め |
| 1.75倍 | かなり速め |
| 2倍 | 高速 |

---

### 3.4 認証機能

| 項目 | 仕様 |
|------|------|
| 認証方法 | Googleアカウント |
| 必須/任意 | 任意（ログインなしでも無料機能は使用可能） |
| 用途 | 有料版の購入・復元、プリセット同期 |

---

### 3.5 バックグラウンド再生

| プラットフォーム | 対応 | 条件 |
|------------------|------|------|
| iOS | ○ | 有料版のみ |
| Web | × | 技術的制約により非対応 |

**iOS実装詳細:**
- AVAudioSessionのカテゴリを`.playback`に設定
- Background Modes で Audio を有効化
- ネイティブオーディオモジュールで処理することでバックグラウンドでも正確なテンポを維持

---

### 3.6 オフライン対応

| 機能 | オフライン対応 |
|------|----------------|
| メトロノーム | ○ |
| タイマー | ○ |
| 音源再生（ローカル） | ○ |
| 音源再生（クラウド保存分） | △（ダウンロード済みのみ） |
| ループポイント保存 | ×（オンライン必要） |
| ループポイント呼び出し | △（キャッシュ済みのみ） |
| 認証 | ×（初回のみオンライン必要） |
| 課金 | × |
| プリセット同期 | × |

**クラウド音源のキャッシュ:**
- ダウンロード済みの音源は端末にキャッシュ
- オフライン時もキャッシュから再生可能

---

## 4. 課金・広告

### 4.1 プラン比較

| 機能 | 無料版 | 有料版（月額200円） |
|------|--------|---------------------|
| メトロノーム | ○ | ○ |
| タイマー | ○ | ○ |
| 音源再生（通常） | ○ | ○ |
| 広告 | 表示 | **非表示** |
| BPMプリセット保存 | × | **○（10個まで）** |
| タイマープリセット保存 | × | **○（10個まで）** |
| A-Bリピート | × | **○** |
| ループポイント保存 | × | **○（3個まで）** |
| 再生速度変更 | × | **○** |
| バックグラウンド再生（iOS） | × | **○** |

### 4.2 広告仕様

| 項目 | 仕様 |
|------|------|
| 広告種類 | バナー広告のみ |
| 配信 | Google AdSense / AdMob |
| 表示タイミング | 常時表示 |

**iOS版:**
| 配置 | サイズ |
|------|--------|
| 画面下部 | 標準バナー（320x50 または 自動サイズ） |

**Web版（レスポンシブ）:**
| 画面幅 | 配置 | サイズ |
|--------|------|--------|
| 1440px以上 | 左側部 + 右側部 + 下部中央 | 側部: 160x600px / 下部: 728x90px |
| 1280px〜1440px | 右側部 + 下部中央 | 側部: 160x600px / 下部: 728x90px |
| 1120px〜1280px | 下部中央のみ | 728x90px |
| 1120px未満 | 下部中央のみ | 320x50px（スマホサイズ） |

**注意:** 広告読み込みによるパフォーマンス低下を最小限にするため、以下を実施：
- 広告の遅延読み込み（メトロノーム開始後に読み込み）
- 広告更新頻度の最適化

### 4.3 決済システム

| プラットフォーム | 決済方法 | 手数料目安 |
|------------------|----------|------------|
| iOS | App Store In-App Purchase | 15〜30% |
| Web | Stripe | 3.6% |

### 4.4 アカウント連携
- 同一Googleアカウントでログインすれば、iOS/Web両方で有料機能を利用可能
- 課金状態はFirestoreで管理し、プラットフォーム間で同期

---

## 5. 画面構成

### 5.1 全体レイアウト方針
- **全機能を1画面に収める**（メトロノーム・タイマー・音源再生）
- 画面遷移を最小限にし、練習中の操作性を重視

### 5.2 レスポンシブレイアウト

| 画面幅 | レイアウト | 広告配置 |
|--------|------------|----------|
| 1440px以上 | 3機能横並び | 左右側部 + 下部中央 |
| 1280px〜1440px | 3機能横並び | 右側部 + 下部中央 |
| 1120px〜1280px | 3機能横並び | 下部中央のみ |
| 1120px未満 | スライダー切り替え | 下部のみ |
| iOSアプリ | スライダー切り替え | 下部のみ |

```
【Web版 1440px以上】
┌───┬─────────────────────────────────────────────────┬───┐
│   │  ヘッダー（Language / サブスクリプション / ログイン）│   │
│ 広├─────────────────┬─────────────────┬─────────────┤ 広│
│ 告│                 │                 │             │ 告│
│   │  メトロノーム    │    タイマー      │  音源再生   │   │
│160│                 │                 │             │160│
│×  │                 │                 │             │ × │
│600├─────────────────┴─────────────────┴─────────────┤600│
│   │           広告（下部 728×90px）                  │   │
└───┴─────────────────────────────────────────────────┴───┘

【Web版 1120px〜1440px】
┌─────────────────────────────────────────────────────────┐
│  ヘッダー（Language / サブスクリプション / ログイン）     │
├─────────────────┬─────────────────┬─────────────────────┤
│                 │                 │                     │
│  メトロノーム    │    タイマー      │    音源再生          │
│                 │                 │                     │
├─────────────────┴─────────────────┴─────────────────────┤
│                 広告（下部 728×90px）                    │
└─────────────────────────────────────────────────────────┘

【Web版 1120px未満 / iOSアプリ】
┌─────────────────────┐
│  Language  ≡ メニュー│
├─────────────────────┤
│                     │
│  ← スワイプで切替 →  │
│  [メトロノーム]      │
│  [タイマー]         │
│  [音源再生]         │
│                     │
├─────────────────────┤
│  広告（下部）        │
└─────────────────────┘
```

### 5.3 ヘッダー構成

**Web版（1120px以上）:**
| 位置 | 要素 | 説明 |
|------|------|------|
| 右上 | Languageドロップダウン | 言語切り替え（日本語/英語/スペイン語） |
| 右上 | サブスクリプション | クリックで課金ポップアップを表示 |
| 右上 | ログイン/ログアウト | クリックでログインポップアップを表示 |

**iOS版 / Web版（1120px未満）:**
| 位置 | 要素 | 説明 |
|------|------|------|
| 左上 | Languageドロップダウン | 言語切り替え |
| 右上 | ハンバーガーメニュー（≡） | タップでメニューを展開 |

**ハンバーガーメニュー内の項目:**
| 項目 | 動作 |
|------|------|
| ログイン / ログアウト | ログインポップアップを表示 |
| サブスクリプション | 課金ポップアップを表示 |
| 解約 | 解約確認ポップアップを表示 |

### 5.4 ポップアップ画面

#### 5.4.1 ログインポップアップ
| 要素 | 説明 |
|------|------|
| タイトル | 「ログイン」 |
| Googleログインボタン | Googleアカウントでサインイン |
| 閉じるボタン | ポップアップを閉じる |

#### 5.4.2 課金ポップアップ
| 要素 | 説明 |
|------|------|
| タイトル | 「プレミアムプラン」 |
| プラン説明 | 月額200円、機能一覧 |
| 購入ボタン | 決済処理を開始 |
| エラー表示エリア | 課金失敗時に原因を表示 |
| 閉じるボタン | ポップアップを閉じる |

#### 5.4.3 解約ポップアップ
| 要素 | 説明 |
|------|------|
| タイトル | 「プランの解約」 |
| 確認メッセージ | 解約後の影響説明 |
| 解約ボタン | 解約処理を実行 |
| キャンセルボタン | ポップアップを閉じる |

#### 5.4.4 プリセット管理ポップアップ（有料版）
| 要素 | 説明 |
|------|------|
| プリセット一覧 | 保存済みプリセットをリスト表示 |
| 選択 | タップで設定を適用 |
| 削除 | スワイプまたは削除ボタンで削除 |
| 新規保存 | 現在の設定を保存 |

### 5.5 各機能パネルの構成

#### 5.5.1 メトロノームパネル
| 要素 | 説明 |
|------|------|
| 振り子アニメーション | 再生中にBPMに合わせて左右に動く振り子を表示 |
| BPM表示 | 大きな数字で現在のBPMを表示 |
| BPM調整（±ボタン） | タップで1ずつ増減 |
| ビートインジケーター | 拍子に応じた丸印。再生中は現在の拍を点灯して表示 |
| 拍子セレクター | 「拍子を選択」ドロップダウンで選択 |
| アクセントセレクター | 「アクセントを選択」ドロップダウンで3パターンから選択（拍子セレクターと横並び） |
| BPMプリセット選択（有料版） | 「BPMを選択」ドロップダウンで保存済みプリセットを選択 |
| STARTボタン | メトロノームの開始・停止 |
| SAVEボタン（有料版） | 現在のBPM+拍子+アクセント設定をプリセットとして保存 |

#### 5.5.2 タイマーパネル
| 要素 | 説明 |
|------|------|
| 時間表示 | HH:MM:SS 形式で大きく表示 |
| 加算ボタン群 | 30秒 / 1分 / 3分 / 5分 / 10分 / 30分 |
| 時間プリセット選択（有料版） | 「時間を選択」ドロップダウンで保存済みプリセットを選択 |
| STARTボタン | カウントダウン開始（再生中は一時停止ボタンに変化） |
| SAVEボタン（有料版） | 現在の設定時間をプリセットとして保存 |

#### 5.5.3 音源再生パネル
| 要素 | 説明 |
|------|------|
| 15秒戻るボタン | 再生位置を15秒前に戻す |
| 再生/一時停止ボタン | 再生コントロール |
| 15秒進むボタン | 再生位置を15秒先に進める |
| シークバー | 再生位置の表示・変更 |
| A-B区間設定（有料版） | A点（開始）とB点（終了）の時間を入力欄で設定 |
| LOOPボタン（有料版） | A-Bループ再生のオン/オフを切り替え |
| 再生速度セレクター（有料版） | A-B区間設定の下部に配置。0.5x〜2x から選択 |
| ファイル選択ボタン | 「ファイルを選択」ボタンでOS標準ファイルピッカーを起動 |
| アップロードボタン（有料版） | 選択した音源をクラウドにアップロード |
| ファイルサイズ制限注記 | 「アップロードする音源ファイルは20MB以下にしてください」と表示 |
| SAVEボタン（有料版） | 音源+A-B区間をクラウドに保存（上限3個） |
| エラー表示エリア | ファイル読み込み失敗時に原因を表示（ボタン下部） |

### 5.6 有料版機能のアクセス制御

未ログイン・未課金ユーザーが有料版機能のボタンを押した場合の挙動：

| 状態 | ボタン押下時の動作 |
|------|-------------------|
| 未ログイン | ログインポップアップを表示 |
| ログイン済み・未課金 | 課金ポップアップを表示 |
| 課金済み | 通常の機能を実行 |

**対象となる有料版機能ボタン:**
- メトロノーム：SAVEボタン、BPMを選択
- タイマー：SAVEボタン、時間を選択
- 音源再生：LOOPボタン、A-B区間設定、再生速度セレクター、アップロードボタン、SAVEボタン

---

### 5.7 エラー表示仕様

| エラー種別 | 表示位置 | 表示内容 |
|------------|----------|----------|
| 課金失敗 | 課金ポップアップ内 | 失敗の旨 + 原因（例：「決済に失敗しました。カード情報をご確認ください」） |
| ファイル読み込み失敗 | ファイル選択ボタンの下部 | 失敗の旨 + 原因（例：「ファイルを読み込めませんでした。対応形式：mp3, wav」） |
| ネットワークエラー | 該当操作のエリア内 | 「インターネット接続を確認してください」 |
| ログイン失敗 | ログインポップアップ内 | 「ログインに失敗しました。再度お試しください」 |

### 5.8 ファイル選択UI

| 項目 | 仕様 |
|------|------|
| 方式 | OS標準ファイルピッカー |
| iOS | UIDocumentPickerViewController |
| Web | `<input type="file">` |
| フィルター | .mp3, .wav のみ表示 |

---

## 6. 非機能要件

### 6.1 パフォーマンス
| 項目 | 要件 |
|------|------|
| メトロノーム精度 | ±1ms以内の誤差 |
| アプリ起動時間 | 3秒以内 |
| メモリ使用量 | 最小限に抑える |

### 6.2 セキュリティ
| 項目 | 対策 |
|------|------|
| 認証 | Firebase Authentication使用 |
| 通信 | HTTPS必須 |
| 課金検証 | サーバーサイドでレシート検証 |

### 6.3 可用性
| 項目 | 要件 |
|------|------|
| オフライン | コア機能はオフラインで動作 |
| エラー処理 | ネットワークエラー時は適切なメッセージ表示 |

---

## 7. 将来の拡張候補（初期リリース対象外）

以下は初期リリースには含めないが、将来的に検討する機能：

| 機能 | 説明 |
|------|------|
| 練習履歴 | 練習時間の記録・可視化 |
| チューナー | マイクを使ったチューニング機能 |
| コード進行表示 | メトロノームに合わせてコード名を表示 |
| Android対応 | Androidアプリのリリース |

---

## 8. 用語集

| 用語 | 説明 |
|------|------|
| BPM | Beats Per Minute。1分間の拍数 |
| 拍子 | 楽曲のリズムの基本単位（4/4拍子など） |
| A-Bリピート | 指定した区間（A点〜B点）を繰り返し再生する機能 |
| プリセット | よく使う設定を保存したもの |

---

## 更新履歴

| 日付 | バージョン | 内容 |
|------|------------|------|
| 2026-02-20 | 1.0 | 初版作成 |
| 2026-02-20 | 1.1 | 画面構成の詳細を追加（レイアウト、ポップアップ、エラー表示仕様） |
| 2026-02-21 | 1.2 | ループポイント保存機能を追加（有料版、3個まで） |
| 2026-02-21 | 1.3 | 音源クラウド同期対応（Firebase Storage）、著作権注意事項追加 |
| 2026-02-21 | 1.4 | 音源アップロードパネルにファイルサイズ制限注記を追加 |
| 2026-02-22 | 2.0 | デザイン確定に伴う大幅更新：レスポンシブブレークポイント変更、広告サイズ詳細追加、振り子アニメーション・ビートインジケーター追加、タイマープリセット保存機能追加、有料版機能アクセス制御追加 |
